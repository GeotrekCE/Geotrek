#!/bin/bash

DATABASE=$1 # "medium" or "big"
SESSION_ID=$2
MEASURES_DIR=./time_measures

NB_MEASURES=15
STEPS_MEDIUM_DB='{"steps":[{"lat":48.78865110305786,"lng":-0.7288733571013117},{"lat":48.80584273280579,"lng":0.6220385061652144},{"lat":48.70132029839784,"lng":-0.6460571927537084},{"lat":48.80810193238519,"lng":-0.5094456191431829},{"lat":48.73016652617093,"lng":-0.006152672135373294},{"lat":48.72128114794426,"lng":0.15911115197790426},{"lat":48.53339701737385,"lng":0.6481866846351592},{"lat":48.51037384095142,"lng":0.6742131302340004},{"lat":48.30470037073643,"lng":0.5373507987112802},{"lat":48.61087801094329,"lng":-0.6010165839374038},{"lat":48.63148856632016,"lng":-0.2139951857060396},{"lat":48.67504400802059,"lng":-0.07693159072508003},{"lat":48.94942816612855,"lng":0.2542923244807671},{"lat":48.77481419406714,"lng":0.3728876570095352},{"lat":48.835845510898245,"lng":0.3336401014494683},{"lat":48.859204329835805,"lng":0.32585907520646273},{"lat":48.88428331908966,"lng":0.2668428491315922},{"lat":48.930385930287414,"lng":0.16267849255688024},{"lat":48.88141964657165,"lng":0.12332191167983897},{"lat":48.85684298617886,"lng":0.05253592042242072},{"lat":48.830253196235134,"lng":0.011668305559444647},{"lat":48.782057890140806,"lng":-0.05551825718057124},{"lat":48.67938708405994,"lng":-0.04681460144761784},{"lat":48.64295148518834,"lng":-0.040852306874299416},{"lat":48.61316459119114,"lng":-0.09570193153487948},{"lat":48.609626750842196,"lng":-0.2069947671944683},{"lat":48.595414311822104,"lng":-0.3860577073780469},{"lat":48.5778412813796,"lng":-0.43634842701551824},{"lat":48.61687177714385,"lng":-0.46854038183260943},{"lat":48.640584417463856,"lng":-0.45624503479994033},{"lat":48.64011959658956,"lng":-0.48803680689007534},{"lat":48.612043882720144,"lng":-0.5199207339486067},{"lat":48.61395837666857,"lng":-0.5708177064959319},{"lat":48.58780058042793,"lng":-0.5998652213940181},{"lat":48.548032510021265,"lng":-0.4895475383666126},{"lat":48.530607635664275,"lng":-0.4423691085976844},{"lat":48.521615096775434,"lng":-0.3162494555737094},{"lat":48.47046257250514,"lng":-0.15201938052184394},{"lat":48.57413902274528,"lng":-0.12063008418569333},{"lat":48.5822786054306,"lng":-0.0309707116871083},{"lat":48.61152028868329,"lng":0.026789055689158126},{"lat":48.399999045053384,"lng":0.30498319688921693},{"lat":48.30171889573409,"lng":0.6833068750095617},{"lat":48.37746146750276,"lng":0.6209322552980234},{"lat":48.43067764258288,"lng":0.7381279844073907},{"lat":48.404180740445426,"lng":0.5692977750647366},{"lat":48.50212502672558,"lng":0.6376709242337064},{"lat":48.486922956296105,"lng":0.6506543349664318},{"lat":48.49124378927769,"lng":0.6834466810338791},{"lat":48.53594820782899,"lng":0.6912759866210871},{"lat":48.54027276385732,"lng":0.6864564725984179},{"lat":48.579515975293454,"lng":0.7066250041055788},{"lat":48.577206973916915,"lng":0.6724788840704443},{"lat":48.52918167987667,"lng":0.6267138029727936},{"lat":48.535869923993154,"lng":0.5931380535115505},{"lat":48.46423146218543,"lng":0.45510567520329115},{"lat":48.52095269708345,"lng":0.46465665211352647},{"lat":48.5399946585753,"lng":0.3788066781948407},{"lat":48.56379576475094,"lng":0.2630309414585996},{"lat":48.61646919846034,"lng":0.35175893044459},{"lat":48.643128459622496,"lng":0.35496518652398557},{"lat":48.65980086665077,"lng":0.34740092486782},{"lat":48.65668147144841,"lng":0.32454210724210064},{"lat":48.6519786048777,"lng":0.28471129165747566},{"lat":48.661613840267556,"lng":0.25659761837650397},{"lat":48.703908949327136,"lng":0.25924247790093613},{"lat":48.64458986029422,"lng":0.2042479551590226},{"lat":48.692010149169576,"lng":0.1248625793897684},{"lat":48.697650867780496,"lng":0.09230226251230267},{"lat":48.6919230458454,"lng":-0.010620131723837467},{"lat":48.7322051075422,"lng":-0.040250620249755446},{"lat":48.68515164788414,"lng":-0.14202598415092194},{"lat":48.740002191929506,"lng":-0.10887379190408053},{"lat":48.75458785514362,"lng":-0.14825626232113365},{"lat":48.78296915752634,"lng":-0.1665166507784277},{"lat":48.77513307557813,"lng":-0.206929763890189},{"lat":48.74500180371062,"lng":-0.24059165479055397},{"lat":48.80812860618619,"lng":-0.2912628920545135},{"lat":48.77482621389991,"lng":-0.3213904935954237},{"lat":48.79490801465761,"lng":-0.35161978462760146},{"lat":48.75024318456562,"lng":-0.4234613656884667},{"lat":48.772097225204334,"lng":-0.45770207993914175},{"lat":48.80337739301909,"lng":-0.47881062837729743},{"lat":48.81107102379582,"lng":-0.48755812483683986},{"lat":48.77718283330494,"lng":-0.5194979864651272},{"lat":48.784514261157256,"lng":-0.5297355206956977},{"lat":48.78614447993162,"lng":-0.563250146126284},{"lat":48.748074108800125,"lng":-0.5373664136962453},{"lat":48.718714796472085,"lng":-0.555261541879053},{"lat":48.78146524169051,"lng":-0.6355994412472632},{"lat":48.766077469532114,"lng":-0.6064799138522714},{"lat":48.80534450893845,"lng":-0.6251838056860093},{"lat":48.817546679526814,"lng":-0.6629751027411923},{"lat":48.765214291818566,"lng":-0.6846507917599065},{"lat":48.73732889388191,"lng":-0.6272378769439935},{"lat":48.67860960959203,"lng":-0.6439705096887893},{"lat":48.675602735973214,"lng":-0.6808833514021839},{"lat":48.7317947128601,"lng":-0.7163158886743126},{"lat":48.801172587716884,"lng":0.44513772860787615},{"lat":48.77611045725823,"lng":0.6948773782749429},{"lat":48.74859342587699,"lng":0.6153441903543699},{"lat":48.74387027856652,"lng":0.4986839029767154}]}'
STEPS_BIG_DB='{"steps":[{"lat":48.63950999243303,"lng":0.2604644963783054}]}'

launch_scenario() {
# $1 (boolean): if true, keep the backend cache before each spec run

    # Reset the time measure files
    if [ -d "$MEASURES_DIR" ]; then
        rm -f "$MEASURES_DIR"/time_measures_*
    else
        mkdir "$MEASURES_DIR"
    fi

    for i in $(seq 1 $NB_MEASURES)
    do
        if ! $1; then
            # Empty the backend cache
            curl 'http://geotrek.local:8000/admin/clearcache/' -X POST -H "Cookie: csrftoken=jJPzy1w4p7KNspD9QG1Y2xOqG8Oczf2l; sessionid=$SESSION_ID" --data-raw 'csrfmiddlewaretoken=VihAxtR8JyN10VzyXyyEAUSiwWIbVnPG4RWZVkd2YvnEia2xD4psshwy2UmdksHR&cache_name=fat'
        fi

        if [[ "$DATABASE" == "medium" ]]; then
            STEPS="$STEPS_MEDIUM_DB"
        else
            STEPS="$STEPS_BIG_DB"
        fi
        # Send a request to take the time measures
        curl 'http://geotrek.local:8000/api/path/drf/paths/route-geometry' -X POST \
             -H 'X-CSRFToken: DKUegVuaV01Lsb2s4ORLTx6dqG7CWiFP' \
             -H 'Content-Type: application/json; charset=UTF-8' \
             -H "Cookie: csrftoken=DKUegVuaV01Lsb2s4ORLTx6dqG7CWiFP; sessionid=$SESSION_ID" \
             --data-raw "$STEPS" \
             -s -o /dev/null
        echo '' >> "$MEASURES_DIR"/time_measures_py.txt
    done

    # Compute and display the average times
    echo "Branch:" $(git rev-parse --abbrev-ref HEAD) >> "$MEASURES_DIR"/time_averages.txt
    echo "Database:" $DATABASE >> "$MEASURES_DIR"/time_averages.txt
    echo "Backend cache:" $1 >> "$MEASURES_DIR"/time_averages.txt
    echo "Number of runs:" $NB_MEASURES >> "$MEASURES_DIR"/time_averages.txt
    python3 ./time_averages.py >> "$MEASURES_DIR"/time_averages.txt
    echo "" >> "$MEASURES_DIR"/time_averages.txt
}

# Reset the time averages files
if [ -d "$MEASURES_DIR" ]; then
        rm -f "$MEASURES_DIR"/time_averages.txt
    else
        mkdir "$MEASURES_DIR"
    fi
launch_scenario false
launch_scenario true