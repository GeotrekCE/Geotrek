{% extends "mapentity/base.html" %} 
{% load i18n static sensitivity_extras attachments_tags thumbnail leaflet_tags %} {% block extrahead %}

<style>
  html,
  body {
    min-height: 100vh !important;
  }
  #container {
    padding-top: unset;
    flex: 1;
  }
  #app {
    flex: 1;
    height: 100vh;
    max-height: 100vh !important;
  }
  #desc {
    overflow-y: auto;
    height: 100%;
    max-height: 100vh !important;
  }
  #descHeader {
    background-color: #e6e6e6;
  }

  #map {
    min-height: 500px;
    height: 100% !important;
  }
  .current-month {
    border-bottom: 5px solid var(--danger);
  }
  h2,
  h3 {
    color: var(--primary);
  }
  .legend {
    background-color: rgba(255,255,255,0.8);
    padding: 5px;
    border-radius: 5px;
  }
</style>

{% endblock extrahead %} {% block navbar %}
<!-- No bar -->
{% endblock navbar %} {% block mainpanel %}
<div class="container-fluid h-100">
  <div class="row min-vh-100">
    {% if object %}
    <div class="col-sm p-0">
      <div id="desc" class="h-100 d-flex flex-column">
        <div v-if="sensitiveArea">
          <div id="descHeader" class="p-3">
            {% for p in object.species.practices.all %}
            <span class="m-1 p-1 badge badge-info float-right">{{p}}</span>
            {%endfor%}
            <h2 class="text-uppercase">{{object.species.name}}</h2>
            <p>
              <span class="badge badge-success"
                >{% if object.species.category == 1 %}Zone espèce{%else%}Zone
                réglementaire{%endif%}</span
              >
              créée par <strong>{{object.structure}}</strong>
            </p>
          </div>
          <div id="descContent" class="p-3">
            <div class="block">
              <h3>Période de sensibilité</h3>

              <div class="text-center">
                {% for p in object.species.list_period %}
                <span
                  data-toggle="tooltip"
                  data-placement="bottom"
                  data-toggle-title="{%if p%}Période sensible{%else%}Hors période sensible{%endif%}"
                  title="{%if p%}Période sensible{%else%}Hors période sensible{%endif%}"
                  class="m-1 p-1 badge text-uppercase {%if p%}badge-warning{%else%}badge-success{%endif%} {%if forloop.counter == current_month %}current-month{%endif%}"
                  >{{forloop.counter|month_abbr}}</span
                >
                {% endfor %}
              </div>
              <div
                class="alert {% if current_sensitivity %}alert-warning{%else%}alert-success{% endif %}"
                role="alert"
              >
                Statut de sensibilité aujourd'hui&nbsp;:
                <span
                  class="badge text-uppercase {% if current_sensitivity %}badge-warning{%else%}badge-success{% endif %}"
                  >{% if current_sensitivity %}
                  Sensible
                  {%else%}
                  Non sensible
                  {% endif %}
                </span>
              </div>
            </div>
            <div class="block">
              <h3>Description</h3>
              {% if object.description %}
              <div>{{object.description|safe}}</div>
              {%else%}
              <div class="text-muted">Pas de description</div>
              {%endif%}
            </div>
            <div class="block">
              <h3>Contact</h3>
              {% if object.contact %}
              <div>{{object.contact|safe}}</div>
              {%else%}
              <div class="text-muted">Pas de contact</div>
              {%endif%}
            </div>

            {% if object.attachments.count > 0 %}
            <div id="attachments">
              <h3>Documents joints</h3>
              <ul class="list-unstyled">
                {% for a in object.attachments.all %}
                <li class="media py-2">
                  <img
                    src="{%if a.is_image %}{{a.attachment_file.url}}{%else%}{% svg_thumbnail a.filetype width=100 height=100 %}{%endif%}"
                    class="mr-3"
                    alt="{{a.title}}"
                    class="img-thumbnail rounded"
                    height="100"
                    width="100"
                    title="{{a.title}}"
                  />
                  <div class="media-body">
                    <span
                      class="float-right m-1 p-1 badge text-uppercase badge-success"
                      >{{a.filetype.type}}</span
                    >
                    <h5 class="mt-0 mb-1">
                      <a
                        href="{{a.attachment_file}}"
                        targer="_blank"
                        title="Télécharger"
                        >{{a.title}}</a
                      >
                    </h5>

                    <small>Autheur: {{a.author}}</small> |
                    <small>Licence: {{a.license}}</small><br />
                    <p>{{a.legend}}</p>
                  </div>
                </li>
                {%endfor%}
              </ul>
            </div>
            {%endif%}
            <div id="links" class="text-center">
              {%if object.species.url %}
              <a
                href="{{object.species.url}}"
                class="btn btn-success m-2"
                target="_blank"
                ><i class="bi bi-info-circle-fill"></i> Plus d'informations</a
              >
              {% endif %} {% if object.kml %}
              <a
                href="{% url 'sensitivity:sensitivearea_kml_detail' lang=LANGUAGE_CODE pk=object.pk %}"
                class="btn btn-primary m-2"
                target="_blank"
                ><i class="bi bi-cloud-download-fill"></i> KML</a
              >
              {% endif %} {% if object.openair %}
              <a
                href="{% url 'sensitivity:sensitivearea_openair_detail' lang=LANGUAGE_CODE pk=object.pk %}"
                class="btn btn-primary m-2"
                target="_blank"
                ><i class="bi bi-cloud-download-fill"></i> OpenAir</a
              >
              {% endif %} {% if object %}
              <a
                href="{% url 'apiv2:sensitivearea-detail' pk=object.pk format='geojson' %}"
                class="btn btn-primary m-2"
                target="_blank"
                ><i class="bi bi-cloud-download-fill"></i> GeoJSON</a
              >
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    <div class="col-sm p-0">
      {% leaflet_map "map" callback="window.map_init_basic" %}
    </div>
  </div>
</div>
<script>
  sensitiveAreaPk = "{{object.pk}}";

  saMap = document.getElementById("map");
  saMap.classList.add("h100", "d-flex", "flex-column");

  const url = "{{object.pk}}"
    ? `/api/v2/sensitivearea/${sensitiveAreaPk}/?format=geojson&period=any`
    : `/api/v2/sensitivearea/?format=geojson&period=any`;

  const getGeoJson = async () => {
    const response = await fetch(url);
    return await response.json();
  };

  const styleColor = (d)=>{
    return d > 0 ? 'var(--success)' : 'var(--info)';
  };

  const styleArea = (feature) => {
    return {
        fillColor: styleColor(feature.properties.species_id),
        weight: 2,
        opacity: 0.9,
        color: styleColor(feature.properties.species_id),
        fillOpacity: 0.3
    };
  };

  const typeZoneBadgeStyle = (species_id) => {
    return `badge ${species_id > 0 ? 'badge-success' : 'badge-info'}`
  }

  function onEachFeature(feature, layer) {
    if (feature.properties && feature.properties.name) {
      const featureName = feature.properties.name;
      // Find first not null name if local name is null
      const name = featureName["{{LANGUAGE_CODE}}"]
        ? featureName["{{LANGUAGE_CODE}}"]
        : Object.entries(featureName).filter(([key, value]) => !!value)[0][1];
      layer.bindPopup(`
        <p class="text-center">
          <a href="/api/v2/sensitivearea/${feature.id}.html">
            ${name} 
          </a><br>
          <span class="badge ${typeZoneBadgeStyle(feature.properties.species_id)}"
            >${feature.properties.species_id > 0 ? 'Zone espèce' : 'Zone réglementaire'}</span
          >
        </p>`);
    }
  }

  const Legend = (map) => {
    const legend = L.control({position: 'bottomleft'})
    legend.onAdd = function (map) {
        const div = L.DomUtil.create("div", "info legend");
        const items = [["badge-info","Zone réglementaire"], ["badge-success","Zone espèce"]];
        items.forEach((e) => div.innerHTML += '<span class="badge ' + e[0] + '">' + e[1] + "</span><br>")
        return div;
      };
    legend.addTo(map);
    };

  

  const loadMapData = (map) => {
    getGeoJson().then((r) => {
      const area = L.geoJson(r, { onEachFeature: onEachFeature, style: styleArea });
      map.fitBounds(area.getBounds());
      map.setMaxBounds(area.getBounds());
      area.addTo(map);
      Legend(map);
    });
  };

  function map_init_basic(map, options) {
    loadMapData(map);    
  }
</script>

{% endblock mainpanel %}
